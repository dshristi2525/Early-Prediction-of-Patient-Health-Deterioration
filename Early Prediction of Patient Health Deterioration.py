# -*- coding: utf-8 -*-
"""Untitled0.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1e7MFwRxiFaxsyXz51-359lVpvulMgHhS
"""

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt

from sklearn.preprocessing import MinMaxScaler
from sklearn.model_selection import train_test_split
from sklearn.metrics import classification_report, confusion_matrix

import tensorflow as tf
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import LSTM, Dense, Dropout

np.random.seed(42)

NUM_PATIENTS = 500
DAYS = 14

data = []

for pid in range(NUM_PATIENTS):
    deteriorates = np.random.choice([0, 1], p=[0.7, 0.3])

    temp = 38 - np.linspace(0, 1.5, DAYS) + np.random.normal(0, 0.2, DAYS)
    spo2 = 96 + np.linspace(0, 2, DAYS) + np.random.normal(0, 1, DAYS)
    heart_rate = 90 - np.linspace(0, 10, DAYS) + np.random.normal(0, 3, DAYS)

    if deteriorates:
        spo2[-5:] -= np.linspace(2, 6, 5)
        heart_rate[-5:] += np.linspace(5, 15, 5)
        temp[-5:] += np.linspace(0.5, 1.2, 5)

    for day in range(DAYS):
        data.append([
            pid,
            day,
            temp[day],
            spo2[day],
            heart_rate[day],
            deteriorates
        ])

df = pd.DataFrame(data, columns=[
    "patient_id", "day", "temperature", "spo2", "heart_rate", "label"
])

df.head()

sample = df[df.patient_id == 1]

plt.figure(figsize=(10,4))
plt.plot(sample.day, sample.spo2, label="SpO2")
plt.plot(sample.day, sample.heart_rate, label="Heart Rate")
plt.plot(sample.day, sample.temperature, label="Temperature")
plt.legend()
plt.xlabel("Day")
plt.ylabel("Value")
plt.title("Patient Recovery / Deterioration Trend")
plt.show()

features = ["temperature", "spo2", "heart_rate"]

scaler = MinMaxScaler()
df[features] = scaler.fit_transform(df[features])

SEQUENCE_LENGTH = 5

X, y = [], []

for pid in df.patient_id.unique():
    patient_data = df[df.patient_id == pid]
    values = patient_data[features].values
    label = patient_data.label.iloc[0]

    for i in range(len(values) - SEQUENCE_LENGTH):
        X.append(values[i:i+SEQUENCE_LENGTH])
        y.append(label)

X = np.array(X)
y = np.array(y)

print("Input shape:", X.shape)
print("Labels shape:", y.shape)

X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42, stratify=y
)

model = Sequential([
    LSTM(64, input_shape=(X.shape[1], X.shape[2])),
    Dropout(0.3),
    Dense(32, activation='relu'),
    Dense(1, activation='sigmoid')
])

model.compile(
    optimizer='adam',
    loss='binary_crossentropy',
    metrics=['accuracy']
)

model.summary()

history = model.fit(
    X_train, y_train,
    epochs=20,
    batch_size=32,
    validation_split=0.2
)

y_pred = (model.predict(X_test) > 0.5).astype(int)

print(classification_report(y_test, y_pred))

print("Confusion Matrix:")
print(confusion_matrix(y_test, y_pred))

def risk_level(prob):
    if prob < 0.3:
        return "GREEN (Stable)"
    elif prob < 0.6:
        return "YELLOW (Monitor)"
    else:
        return "RED (Doctor Alert)"

sample_prob = model.predict(X_test[:5])

for p in sample_prob:
    print("Risk:", risk_level(float(p)))

feature_means = X_test.mean(axis=1)

plt.figure(figsize=(8,4))
plt.bar(features, feature_means[0])
plt.title("Feature Contribution Snapshot")
plt.ylabel("Normalized Value")
plt.show()

def get_patient_input():
    print("Enter last 5 days patient data")
    temp = []
    spo2 = []
    hr = []

    for i in range(5):
        print(f"\nDay {i+1}")
        temp.append(float(input("Temperature (Â°C): ")))
        spo2.append(float(input("SpO2 (%): ")))
        hr.append(float(input("Heart Rate (bpm): ")))

    data = np.array(list(zip(temp, spo2, hr)))
    data = scaler.transform(data)  # normalize
    return data.reshape(1, 5, 3)

def predict_patient_risk():
    patient_seq = get_patient_input()
    risk_prob = float(model.predict(patient_seq)[0])

    if risk_prob < 0.3:
        status = "ðŸŸ¢ GREEN â€“ Stable"
    elif risk_prob < 0.6:
        status = "ðŸŸ¡ YELLOW â€“ Monitor Closely"
    else:
        status = "ðŸ”´ RED â€“ Doctor Attention Required"

    print("\n==============================")
    print(f"Predicted Deterioration Risk: {risk_prob:.2f}")
    print(f"Status: {status}")
    print("==============================")

    return patient_seq

6patient_data = predict_patient_risk()
44

def plot_patient_trend(patient_seq):
    patient_seq = patient_seq.reshape(5, 3)

    plt.figure(figsize=(10,4))
    plt.plot(patient_seq[:,0], label="Temperature")
    plt.plot(patient_seq[:,1], label="SpO2")
    plt.plot(patient_seq[:,2], label="Heart Rate")
    plt.legend()
    plt.xlabel("Days")
    plt.ylabel("Normalized Value")
    plt.title("Patient Health Trend (Last 5 Days)")
    plt.show()

plot_patient_trend(patient_data)

def analyze_trend(patient_seq):
    """
    patient_seq: shape (1, 5, 3) â†’ last 5 days data
    """
    seq = patient_seq.reshape(5, 3)

    temp_trend = seq[-1, 0] - seq[0, 0]
    spo2_trend = seq[-1, 1] - seq[0, 1]
    hr_trend = seq[-1, 2] - seq[0, 2]

    print("\nðŸ“Š TREND ANALYSIS RESULT")
    print("-------------------------")

    if temp_trend < 0:
        print("âœ” Temperature is decreasing")
    else:
        print("âš  Temperature is increasing")

    if spo2_trend > 0:
        print("âœ” Oxygen level is improving")
    else:
        print("âš  Oxygen level is decreasing")

    if hr_trend < 0:
        print("âœ” Heart rate is stabilizing")
    else:
        print("âš  Heart rate is increasing")

    print("\nðŸ©º FINAL CLINICAL INTERPRETATION")
    print("--------------------------------")

    if temp_trend < 0 and spo2_trend > 0 and hr_trend < 0:
        print("ðŸŸ¢ Patient shows NORMAL RECOVERY pattern.")
        print("âž¡ No immediate medical intervention required.")
    else:
        print("ðŸ”´ ABNORMAL RECOVERY detected.")
        print("âž¡ Early medical review is RECOMMENDED.")

analyze_trend(patient_data)

from sklearn.metrics import (
    accuracy_score,
    precision_score,
    recall_score,
    f1_score,
    roc_auc_score,
    confusion_matrix
)

# Probabilities for AUC
y_prob = model.predict(X_test).ravel()

# Core metrics
accuracy = accuracy_score(y_test, y_pred)
precision = precision_score(y_test, y_pred)
recall = recall_score(y_test, y_pred)
f1 = f1_score(y_test, y_pred)

# Confusion matrix
tn, fp, fn, tp = confusion_matrix(y_test, y_pred).ravel()

# Clinical metrics
specificity = tn / (tn + fp)
sensitivity = recall
auc = roc_auc_score(y_test, y_prob)

print("ðŸ“ˆ MODEL EVALUATION METRICS")
print("---------------------------")
print(f"Accuracy      : {accuracy:.4f}")
print(f"Precision     : {precision:.4f}")
print(f"Recall        : {recall:.4f}")
print(f"F1 Score      : {f1:.4f}")
print(f"Sensitivity   : {sensitivity:.4f}")
print(f"Specificity   : {specificity:.4f}")
print(f"AUC Score     : {auc:.4f}")